A package of .BAT scripts and .sql queries for MSSQL for Windows to perform an automatic backup of many databases ended with generating the SQL query needed to restore this backup. The included scripts support differential and full backups, and the scripts that restore databases from copies can set them to norecovery or recovery mode.
The main application, is a complete backup with automatic recovery procedure.
The second application is to implement a mirror of two or more SQL servers by automatically uploading differential backups of all running databases to the backup server.
(E.g. between MSSQL Server for Linux and for Windows )

Scripts description:

1. backupall.bat [option] [backup_path] -Backup all databases to the backup_path with options for .sql query.

        [options] - string with options pushed to the .sql query after "WITH" 
e.g:
C:\sql\backupall.bat FORMAT,INIT,NO_COMPRESSION c:\dump\sqlfull\		

		
2. backup.sql - used by backupall.bat	-SQL query with options for create backup all databases on 

launched from .bat script by command:

sqlcmd -S [ip_sqlserver] -U sa -P [sqlpassword] -i backupall.sql -v _path="%2" -v _parameters=%1


@path = '$(_path)'    	-- database backup directory
@par = '$(_parameters)'	-- parameters added for restore/attach option to generated script


4. gensql.sql	- used by backupall.bat		-SQL query with options to generate .sql scipt to the STDOUT for multiple operation on databases

launched from .bat script by command - an a example:
sqlcmd -S [ip_sqlserver] -U sa -P [sqlpassword] -i gensql.sql -v _what=restore -v _path="%2" -v _recovery=NORECOVERY -v _files=1 -W >%2restoreall.sql

@folderpath = '$(_path)' 	-- Backup Location
@recovery = '$(_recovery)' 	-- model of recovery
@what = '$(_what)'		-- Type of generated .sql script [attach|restore|setrecovery]
@files = '$(_files)' 		-- FILES parameter

4. copy_mdf.bat %1		 -Copy all databas files from sql server data after stop sql server, than start sql server.

 %1 - path for copy
 
I used scripts by Paul Hewson: https://www.sqlserversnippets.com/2013/10/generate-scripts-to-attach-multiple.html

Greg Robidoux: https://www.mssqltips.com/sqlservertip/1070/simple-script-to-backup-all-sql-server-databases/


__________________________________________________________________________________________________________________________________________________________________________________________


A working example:


	
The scenario of fully restoring the databases from a .bak copy consists of three stages: 

Stage 1: running an automatically generated .sql query restoreall.sql for recovery databases from .bak for FULL copies by command:

    
		
	(Full copies, so the databases recovered in the first stage will be NORECOVERY. Since we assume that there are still differential copies waiting to be restored

{automatically generated by gensql.sql}

	RESTORE DATABASE[AUTOPARTNER] FROM DISK = 'c:\dump\sqlfull\AUTOPARTNER.bak' WITH NORECOVERY,
	
	REPLACE, STATS = 5
	
	RESTORE DATABASE[KR_L_WOJCIECH_LURK] FROM DISK = 'c:\dump\sqlfull\KR_L_WOJCIECH_LURK.bak' WITH NORECOVERY,
	
	REPLACE, STATS = 5


Stage 2: running an automatically generated .sql query restoreall.sql From Differential Copies:
    
	C:\sql\sqlcmd -S localhost -U SA -P 'sqlpassword' -i /srv/backups/diff/restoreall.sql
	
	The recovered databases in the second stage will be NORECOVERY (perheps to the next tasks of recovery )
	
     {automatically generated by gensql.sql}
	 
	RESTORE DATABASE[AUTOPARTNER] FROM DISK = 'c:\dump\sqldiff\AUTOPARTNER.bak' WITH RECOVERY,
	
	REPLACE, STATS = 5
	
	RESTORE DATABASE[KR_L_WOJCIECH_LURK] FROM DISK = 'c:\dump\sqldiff\KR_L_WOJCIECH_LURK.bak' WITH NORECOVERY,
	
	REPLACE, STATS = 5
	
Stage 3: running an automatically generated query setrecoveryall.sql for switch all databases into RECOVERY state. 
_________________________________________________________________________________________________________________________________________________________________________________________

The alternative scenario appends to sql server all previously copied .mdf and.ldf files to the bases folder:
 
	Copy the .mdf and .ldf to the correct mssql data folder.
	
	
running an automatically generated .sql query that performs ATTACH for every databases: 

	sqlcmd -S localhost -U SA -P 'sqlpassword' -i attachall.sql
	
{automatically generated by copy_mdf.bat}:

CREATE DATABASE [AUTOPARTNER] ON

( FILENAME = N'C:\Program Files\Microsoft SQL Server\MSSQL14.MSSQLSERVER\MSSQL\DATA\AUTOPARTNER.mdf' ),

( FILENAME = N'C:\Program Files\Microsoft SQL Server\MSSQL14.MSSQLSERVER\MSSQL\DATA\AUTOPARTNER_log.ldf' )

 FOR ATTACH
 
CREATE DATABASE [KR_L_WOJCIECH_LURK] ON

( FILENAME = N'C:\Program Files\Microsoft SQL Server\MSSQL14.MSSQLSERVER\MSSQL\DATA\KR_L_WOJCIECH_LURK.mdf' ),

( FILENAME = N'C:\Program Files\Microsoft SQL Server\MSSQL14.MSSQLSERVER\MSSQL\DATA\KR_L_WOJCIECH_LURK_log.ldf' )

 FOR ATTACH
 
___________________________________________________________________________________________________________________________________________________________________________________________

I hope that my work will help someone to implement and automate backup or mirror on SQL server for Windows with multiple databases. I would appreciate reporting bugs and suggestions for improving the procedure.



 

						WOJCIECH KROL
						lurk@lurk.com.pl
						2022-10-11

